name: Backend CI

on:
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
  pull_request:
    branches: [ main ]
    paths: 
      - 'backend/**'

jobs:
  build-and-docker:
    name: Build Spring Boot & Docker
    runs-on: ubuntu-latest
    
    steps:
    # RÃ©cupÃ©rer le code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Installer Java 21
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    # Compiler et tester avec Maven
    - name: Build with Maven
      working-directory: ./backend/todo
      run: |
        chmod +x mvnw
        ./mvnw clean compile test --batch-mode
    
    # CrÃ©er le JAR
    - name: Package JAR
      working-directory: ./backend/todo
      run: ./mvnw clean package -DskipTests --batch-mode
    
    # VÃ©rifier que le JAR est crÃ©Ã©
    - name: Verify JAR creation
      working-directory: ./backend/todo
      run: |
        echo "ğŸ“¦ JAR crÃ©Ã© :"
        ls -la target/*.jar
    
    # Construire l'image Docker (sans push)
    - name: Build Docker image
      working-directory: ./backend/todo
      run: |
        docker build -t xks-todo-backend:${{ github.sha }} .
        docker build -t xks-todo-backend:latest .
    
    # VÃ©rifier l'image Docker
    - name: Verify Docker image
      run: |
        echo "ğŸ³ Images Docker crÃ©Ã©es :"
        docker images | grep xks-todo-backend
        echo "ğŸ“ Taille de l'image :"
        docker images xks-todo-backend:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
    
    # Test rapide de l'image
    - name: Test Docker image
      run: |
        echo "ğŸ§ª Test de l'image Docker..."
        docker run --rm -d --name test-backend -p 8080:8080 xks-todo-backend:latest
        sleep 30
        echo "ğŸ¥ Test du health check..."
        curl -f http://localhost:8080/actuator/health || echo "Health check Ã©chouÃ© (normal si pas de actuator)"
        docker stop test-backend
    
    # Simulation du dÃ©ploiement
    - name: Deploy simulation
      run: |
        echo "ğŸ¯ === DÃ‰PLOIEMENT SIMULÃ‰ ==="
        echo "âœ… Spring Boot compilÃ© avec succÃ¨s !"
        echo "ğŸ“¦ JAR crÃ©Ã© dans target/"
        echo "ğŸ³ Image Docker crÃ©Ã©e : xks-todo-backend:latest"
        echo "ğŸš€ PrÃªt pour le dÃ©ploiement !"
        echo "ğŸ’¡ Commande pour dÃ©ployer :"
        echo "   docker run -p 8080:8080 xks-todo-backend:latest"
        echo "ğŸŒ API sera disponible sur : http://localhost:8080"