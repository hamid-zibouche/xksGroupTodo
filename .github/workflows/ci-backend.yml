name: Backend CI

on:
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
  pull_request:
    branches: [ main ]
    paths: 
      - 'backend/**'

jobs:
  build-and-docker:
    name: Build Spring Boot & Docker
    runs-on: ubuntu-latest
    
    steps:
    # Récupérer le code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Installer Java 21
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    # Compiler et tester avec Maven
    - name: Build with Maven
      working-directory: ./backend/todo
      run: |
        chmod +x mvnw
        ./mvnw clean compile test --batch-mode
    
    # Créer le JAR
    - name: Package JAR
      working-directory: ./backend/todo
      run: ./mvnw clean package -DskipTests --batch-mode
    
    # Vérifier que le JAR est créé
    - name: Verify JAR creation
      working-directory: ./backend/todo
      run: |
        echo "📦 JAR créé :"
        ls -la target/*.jar
    
    # Construire l'image Docker (sans push)
    - name: Build Docker image
      working-directory: ./backend/todo
      run: |
        docker build -t xks-todo-backend:${{ github.sha }} .
        docker build -t xks-todo-backend:latest .
    
    # Vérifier l'image Docker
    - name: Verify Docker image
      run: |
        echo "🐳 Images Docker créées :"
        docker images | grep xks-todo-backend
        echo "📏 Taille de l'image :"
        docker images xks-todo-backend:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
    
    # Test rapide de l'image
    - name: Test Docker image
      run: |
        echo "🧪 Test de l'image Docker..."
        docker run --rm -d --name test-backend -p 8080:8080 xks-todo-backend:latest
        sleep 30
        echo "🏥 Test du health check..."
        curl -f http://localhost:8080/actuator/health || echo "Health check échoué (normal si pas de actuator)"
        docker stop test-backend
    
    # Simulation du déploiement
    - name: Deploy simulation
      run: |
        echo "🎯 === DÉPLOIEMENT SIMULÉ ==="
        echo "✅ Spring Boot compilé avec succès !"
        echo "📦 JAR créé dans target/"
        echo "🐳 Image Docker créée : xks-todo-backend:latest"
        echo "🚀 Prêt pour le déploiement !"
        echo "💡 Commande pour déployer :"
        echo "   docker run -p 8080:8080 xks-todo-backend:latest"
        echo "🌐 API sera disponible sur : http://localhost:8080"